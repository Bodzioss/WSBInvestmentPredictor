@page "/expenses/categorize"
@using WSBInvestmentPredictor.Expenses.Shared.Models
@using WSBInvestmentPredictor.Expenses.Shared.Dto
@using Microsoft.Extensions.Localization
@using WSBInvestmentPredictor.Frontend.Shared

<PageTitle>@Loc["CategorizeTransactions"]</PageTitle>

<h1>@Loc["CategorizeTransactions"]</h1>

@if (isLoading)
{
    <div class="d-flex justify-content-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">@Loc["Loading"]</span>
        </div>
    </div>
}
else if (error != null)
{
    <div class="alert alert-danger">
        @error
    </div>
}
else
{
    <div class="mb-3">
        <button class="btn btn-primary" @onclick="ApplyRules">
            <i class="bi bi-magic"></i> @Loc["ApplyRules"]
        </button>
    </div>
    
    @if (transactions == null || !transactions.Any())
    {
        <div class="alert alert-warning">
            @Loc["NoUncategorizedTransactions"]
        </div>
    }
    else
    {
        <div class="table-responsive">
            <RadzenDataGrid Data="@transactions" TItem="BankTransaction" Pageable="true" PageSize="20" Class="transactions-table rz-shadow-1" Responsive="true" AllowSorting="true" AllowColumnResize="true">
                <Columns>
                    <RadzenDataGridColumn TItem="BankTransaction" Property="TransactionDate" Title="@Loc["TransactionDate"]" FormatString="{0:yyyy-MM-dd}" />
                    <RadzenDataGridColumn TItem="BankTransaction" Property="Title" Title="@Loc["Title"]" />
                    <RadzenDataGridColumn TItem="BankTransaction" Property="Amount" Title="@Loc["Amount"]">
                        <Template Context="t">@t.Amount.ToString("N2")</Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="BankTransaction" Property="Category" Title="@Loc["Category"]">
                        <Template Context="t">
                            <select class="form-select" @onchange="e => AssignCategory(t, int.TryParse(e.Value?.ToString(), out var id) ? id : 0)">
                                <option value="0">@Loc["SelectCategory"]</option>
                                @foreach (var cat in categories)
                                {
                                    <option value="@cat.Id">@cat.Name</option>
                                }
                            </select>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="BankTransaction" Title="@Loc["Actions"]">
                        <Template Context="t">
                            <button class="btn btn-link" @onclick="() => GoToAddRule(t.Title)">@Loc["AddRule"]</button>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </div>
    }
}

<style>
.transactions-table {
    background-color: var(--rz-header-background-color);
    color: var(--rz-text-color);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: var(--rz-shadow-1);
    transition: background 0.2s, color 0.2s;
}
.transactions-table th, .transactions-table td {
    border-color: var(--rz-border);
}
.transactions-table tbody tr:hover {
    background-color: var(--rz-table-row-hover-bg);
}
</style>