@page "/transactions"
@using System.Globalization
@using WSBInvestmentPredictor.Expenses.Shared.Models
@using WSBInvestmentPredictor.Expenses.Shared.Cqrs.Queries
@using WSBInvestmentPredictor.Technology.Cqrs
@using Microsoft.Extensions.Localization
@using WSBInvestmentPredictor.Frontend.Shared

<PageTitle>@Loc["NavigationTransactions"]</PageTitle>

<h1>@Loc["NavigationTransactions"]</h1>

<!-- Loading indicator -->
@if (isLoading)
{
    <div class="d-flex justify-content-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">@Loc["Loading"]</span>
        </div>
    </div>
}
<!-- Error message display -->
else if (error != null)
{
    <div class="alert alert-danger">
        @error
    </div>
}
else
{
    <!-- Filter controls -->
    <div class="row mb-3">
        <!-- Year filter -->
        <div class="col-md-3">
            <select class="form-select" @bind="selectedYear" @bind:after="OnYearChanged">
                <option value="0">@Loc["AllYears"]</option>
                @if (years != null)
                {
                    @foreach (var year in years)
                    {
                        <option value="@year">@year</option>
                    }
                }
            </select>
        </div>
        <!-- Month filter -->
        <div class="col-md-3">
            <select class="form-select" @bind="selectedMonth" @bind:after="OnMonthChanged" disabled="@(selectedYear == 0)">
                <option value="0">@Loc["AllMonths"]</option>
                @for (int i = 1; i <= 12; i++)
                {
                    <option value="@i">@CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(i)</option>
                }
            </select>
        </div>
        <!-- Account filter -->
        <div class="col-md-3">
            <select class="form-select" @bind="selectedAccount" @bind:after="OnAccountChanged">
                <option value="">@Loc["AllAccounts"]</option>
                @if (filteredAccounts != null)
                {
                    @foreach (var account in filteredAccounts)
                    {
                        <option value="@account">@account</option>
                    }
                }
            </select>
        </div>
        <!-- Counterparty filter -->
        <div class="col-md-3">
            <select class="form-select" @bind="selectedCounterparty" @bind:after="OnCounterpartyChanged">
                <option value="">@Loc["AllCounterparties"]</option>
                @if (filteredCounterparties != null)
                {
                    @foreach (var counterparty in filteredCounterparties)
                    {
                        <option value="@counterparty">@counterparty</option>
                    }
                }
            </select>
        </div>
    </div>

    <!-- Total amount display -->
    @if (selectedYear > 0)
    {
        <div class="alert alert-info">
            @Loc["TotalFor"] @(selectedMonth > 0 ? $"{CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(selectedMonth)} {selectedYear}" : $"{Loc["Year"]} {selectedYear}"): 
            @totalAmount.ToString("N2") PLN
        </div>
    }

    <!-- No transactions message -->
    @if (transactions == null || !transactions.Any())
    {
        <div class="alert alert-warning">
            @Loc["NoTransactionsFound"] @Loc["PleaseImportSomeTransactionsFirst"]
        </div>
    }
    else
    {
        <!-- Transactions table -->
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>@Loc["TransactionDate"]</th>
                        <th>@Loc["BookingDate"]</th>
                        <th>@Loc["Counterparty"]</th>
                        <th>@Loc["Title"]</th>
                        <th>@Loc["Amount"]</th>
                        <th>@Loc["Currency"]</th>
                        <th>@Loc["Account"]</th>
                        <th>@Loc["Balance"]</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var transaction in transactions)
                    {
                        <tr>
                            <td>@transaction.TransactionDate.ToShortDateString()</td>
                            <td>@(transaction.BookingDate?.ToShortDateString() ?? "-")</td>
                            <td>@transaction.Counterparty</td>
                            <td>@transaction.Title</td>
                            <td>@transaction.Amount.ToString("N2")</td>
                            <td>@transaction.Currency</td>
                            <td>@transaction.Account</td>
                            <td>@(transaction.BalanceAfterTransaction?.ToString("N2") ?? "-") @transaction.BalanceCurrency</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
}