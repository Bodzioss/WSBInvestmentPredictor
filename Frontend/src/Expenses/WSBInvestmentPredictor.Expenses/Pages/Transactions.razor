@page "/transactions"
@using System.Globalization
@using WSBInvestmentPredictor.Expenses.Shared.Models
@using WSBInvestmentPredictor.Expenses.Shared.Cqrs.Queries
@using WSBInvestmentPredictor.Technology.Cqrs
<PageTitle>Transactions</PageTitle>

<h1>Bank Transactions</h1>

@if (isLoading)
{
    <div class="d-flex justify-content-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (error != null)
{
    <div class="alert alert-danger">
        @error
    </div>
}
else
{
    <div class="row mb-3">
        <div class="col-md-3">
            <select class="form-select" @bind="selectedYear" @bind:after="OnYearChanged">
                <option value="0">All Years</option>
                @if (years != null)
                {
                    @foreach (var year in years)
                    {
                        <option value="@year">@year</option>
                    }
                }
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" @bind="selectedMonth" @bind:after="OnMonthChanged" disabled="@(selectedYear == 0)">
                <option value="0">All Months</option>
                @for (int i = 1; i <= 12; i++)
                {
                    <option value="@i">@CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(i)</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" @bind="selectedAccount" @bind:after="OnAccountChanged">
                <option value="">All Accounts</option>
                @if (filteredAccounts != null)
                {
                    @foreach (var account in filteredAccounts)
                    {
                        <option value="@account">@account</option>
                    }
                }
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" @bind="selectedCounterparty" @bind:after="OnCounterpartyChanged">
                <option value="">All Counterparties</option>
                @if (filteredCounterparties != null)
                {
                    @foreach (var counterparty in filteredCounterparties)
                    {
                        <option value="@counterparty">@counterparty</option>
                    }
                }
            </select>
        </div>
    </div>

    @if (selectedYear > 0)
    {
        <div class="alert alert-info">
            Total for @(selectedMonth > 0 ? $"{CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(selectedMonth)} {selectedYear}" : $"Year {selectedYear}"): 
            @totalAmount.ToString("N2") PLN
        </div>
    }

    @if (transactions == null || !transactions.Any())
    {
        <div class="alert alert-warning">
            No transactions found. Please import some transactions first.
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Transaction Date</th>
                        <th>Booking Date</th>
                        <th>Counterparty</th>
                        <th>Title</th>
                        <th>Amount</th>
                        <th>Currency</th>
                        <th>Account</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var transaction in transactions)
                    {
                        <tr>
                            <td>@transaction.TransactionDate.ToShortDateString()</td>
                            <td>@(transaction.BookingDate?.ToShortDateString() ?? "-")</td>
                            <td>@transaction.Counterparty</td>
                            <td>@transaction.Title</td>
                            <td>@transaction.Amount.ToString("N2")</td>
                            <td>@transaction.Currency</td>
                            <td>@transaction.Account</td>
                            <td>@(transaction.BalanceAfterTransaction?.ToString("N2") ?? "-") @transaction.BalanceCurrency</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
}